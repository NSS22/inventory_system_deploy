.container:
  stage: container
  variables:
    AWS_REGION: $AWS_DEFAULT_REGION
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_KEY

.container:build:
  image: docker:stable
  services:
    - docker:24.0.5-dind
  extends: .container
  variables:
    DOCKERFILE: "Dockerfile"
    TAG_PREFIX: ""
  before_script:
    - |
      apk add --no-cache git py3-pip
      pip install awscli
      export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
      export ECR=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      echo $ECR
  script:
    - |
      $(aws ecr get-login --region $AWS_REGION --no-include-email)
      [ $(aws ecr describe-images --repository-name ${IMAGE_NAME} --output json --query "length(imageDetails[?imageTags[0]=='${TAG_PREFIX}${IMAGE_VER}'].imageTags)") -gt 0 ] && echo "Image Already Exists" && exit 0
      git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${SOURCE_REPO} DockerBuild
      cd DockerBuild
      git checkout $IMAGE_VER
      docker build -f ${DOCKERFILE} --build-arg GIT_COMMIT=${IMAGE_VER} --build-arg ACCOUNT=${ACCOUNT} --build-arg DISABLE_SERWIST_CACHING=${DISABLE_SERWIST_CACHING} -t "${IMAGE_NAME}:${IMAGE_VER}" .
      docker tag "${IMAGE_NAME}:${IMAGE_VER}" "${ECR}/${IMAGE_NAME}:${TAG_PREFIX}${IMAGE_VER}"
      docker push "${ECR}/${IMAGE_NAME}:${TAG_PREFIX}${IMAGE_VER}"
  rules:
    - if: $SOURCE_BRANCH =~ /^(develop|release|main)$/
      when: always
    - if: $SOURCE_BRANCH !~ /^(develop|release|main)$/
      when: manual

.container:promote:
  image: amazon/aws-cli
  extends: .container
  script:
    - export ECR=$(aws sts get-caller-identity --query "Account" --output text).dkr.ecr.$AWS_REGION.amazonaws.com
    - eval $(aws ecr get-login --region $AWS_REGION --no-include-email)
    - docker pull "$ECR/$IMAGE_NAME:$IMAGE_VER"
    - export AWS_ACCESS_KEY_ID=$TARGET_ACCOUNT_ID
    - export AWS_SECRET_ACCESS_KEY=$TARGET_ACCOUNT_KEY
    - export PREV_ECR=$ECR
    - export ECR=$(aws sts get-caller-identity --query "Account" --output text).dkr.ecr.$AWS_REGION.amazonaws.com
    - eval $(aws ecr get-login --region $AWS_REGION --no-include-email)
    - docker tag "${PREV_ECR}/${IMAGE_NAME}:${IMAGE_VER}" "${ECR}/${IMAGE_NAME}:${IMAGE_VER}"
    - docker push "$ECR/$IMAGE_NAME:$IMAGE_VER"
  rules:
    - if: $IMAGE_NAME && $IMAGE_VER && $TARGET_ACCOUNT
      when: manual
